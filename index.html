<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Weight Loss Forecast</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Your existing CSS styles unchanged */
        body {
            font-family: sans-serif;
            padding: 20px;
            margin: 0 auto;
            max-width: 960px;
            width: 90%;
            background-color: #1e1e1e;
            color: #fff;
            font-size: 18px;
            line-height: 1.6;
        }

        label {
            display: block;
            margin-top: 25px;
            font-weight: 600;
        }

        #infoBox,
        #infoBox2 {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 16px 20px;
            margin-top: 20px;
            color: #ffffff;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        #infoBox h2 {
            margin-top: 0;
        }

        input {
            background-color: #3a3a3a;
            color: #ffffff;
        }

        button {
            background-color: #3a3a3a;
            color: #ffffff;
            cursor: pointer;
        }

        button:hover {
            background-color: #555;
        }

        input,
        button {
            width: 100%;
            box-sizing: border-box;
            margin-top: 10px;
            padding: 12px;
            font-size: 1rem;
            border-radius: 4px;
            border: none;
            background-color: #2c2c2c;
            color: white;
        }

        button {
            background-color: #3a3a3a;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #555;
        }

        canvas {
            max-width: 100%;
            height: auto !important;
            border-radius: 8px;
            background-color: #2a2a2a;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 0 15px;
            box-sizing: border-box;
        }

        ul {
            margin-top: 20px;
            list-style-type: none;
            padding: 0;
        }

        li {
            padding: 4px 0;
        }

        canvas {
            max-width: 100%;
            background-color: #2a2a2a;
            border-radius: 8px;
        }

        .chart-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
            border-radius: 10px;
            background-color: #2a2a2a;
            position: relative;
            margin-top: 0;
        }

        #forecastOutput {
            background-color: #444;
            border: 2px solid #00cc66;
            border-radius: 8px;
            padding: 16px 20px;
            margin-top: 20px;
            color: #00ff88;
            font-size: 1.2rem;
            font-weight: 700;
            line-height: 1.4;
            text-align: center;
            box-shadow: 0 0 10px #00cc66aa;
        }

        #regressionStats {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 12px 16px;
            margin-top: 12px;
            color: #ffffff;
            font-size: 0.95rem;
            line-height: 1.4;
            font-weight: bold;
        }

        #entryList {
            font-size: 1.1rem;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 18px 24px;
            margin-top: 30px;
            max-height: 250px;
            overflow-y: auto;
            color: #ffffff;
        }

        #forecastResults p {
            margin-top: 8px;
        }

        #entryBox {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        #entryBox input {
            background-color: #3a3a3a !important;
            color: #fff !important;
            border: 1px solid #555;
        }

        #entryBox button {
            margin-bottom: 12px;
            margin-top: 12px;
        }

        #entryList li {
            padding: 4px 8px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #entryList button {
            background-color: #3a3a3a;
            color: #fff;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            min-width: 60px;
            height: 28px;
        }

        #entryList button:hover {
            background-color: #555;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2rem;
                margin-bottom: 20px;
            }

            label {
                font-size: 1.2rem;
                margin-top: 15px;
                margin-bottom: 8px;
            }

            input,
            button {
                font-size: 1.2rem;
                padding: 18px;
                border-radius: 8px;
                margin-top: 15px;
            }

            button {
                width: 100%;
            }

            #infoBox,
            #infoBox2 {
                font-size: 1rem;
                padding: 16px 20px;
            }

            #forecastOutput,
            #regressionStats {
                font-size: 1rem;
                padding: 14px 18px;
                margin-top: 20px;
            }

            #entryList li {
                padding: 4px 8px;
                font-size: 0.9rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            #entryList button {
                background-color: #3a3a3a;
                color: #fff;
                border: none;
                padding: 4px 8px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.75rem;
                min-width: 60px;
                height: 28px;
            }

            #entryList button:hover {
                background-color: #555;
            }

            #localSaveInfo {
                background-color: #2c2c2c;
                border: 1px solid #444;
                border-radius: 6px;
                padding: 12px 16px;
                color: #ccc;
                font-size: 0.9rem;
                margin-top: 20px;
                line-height: 1.4;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Weight Loss Forecast</h1>

        <div id="infoBox">
            <h2>About This Tool</h2>
            <p>HOW IT WORKS:</p>
            <p>
                This weight forecast tool uses a linear regression model to estimate when you might reach your target
                weight based on your logged data. Additionally, it calculates your BMI based on your height and weight. 
                It is for informational purposes only and does not replace
                professional medical advice.
            </p>
            <p>DATA QUANTITY MATTERS:</p>
            <p>
                The accuracy of this forecast improves as you log more daily weight entries over time. More data helps
                the model identify your true trend. For best results, try to log your weight the same time each day (e.g. morning).
            </p>
        </div>

        <label for="targetWeight">Target Weight (kg):</label>
        <input type="number" id="targetWeight" step="0.1" />

        <!-- Added height input for BMI -->
        <label for="heightCm">Height (cm):</label>
        <input type="number" id="heightCm" step="0.1" min="50" max="300" placeholder="e.g. 175" />

        <div id="entryBox">
            <label for="date">Date:</label>
            <input type="date" id="date" />

            <label for="weight">Weight (kg):</label>
            <input type="number" id="weight" step="0.1" />

            <button onclick="addEntry()">Add Entry</button>
            <button onclick="resetAll()">Reset</button>
        </div>
    </div>

    <div id="localSaveInfo"
        style="background-color:#2c2c2c; border:1px solid #444; border-radius:6px; padding: 12px 16px; color:#ccc; font-size: 0.9rem; margin-top: 20px;">
        Your entries are saved locally in your browser. They will remain here if you close or refresh this tab as long
        as
        you use the same device and browser.
        Clicking the <strong>Reset</strong> button will clear all saved data.
    </div>

    <ul id="entryList"></ul>

    <div class="chart-wrapper" style="position: relative; width: 100%; height: 450px; margin-top: 20px;">
        <canvas id="weightChart"></canvas>
    </div>

    <h2>Forecast Chart</h2>

    <div class="chart-wrapper" style="position: relative; width: 100%; height: 450px; margin-top: 20px;">
        <canvas id="forecastChart"></canvas>
    </div>

    <!-- Added BMI Chart -->
    <h2>BMI Chart</h2>
    <div class="chart-wrapper" style="position: relative; width: 100%; height: 450px; margin-top: 20px;">
        <canvas id="bmiChart"></canvas>
    </div>

    <div id="forecastResults" style="margin-top: 20px; font-weight: bold;">
        <p id="forecastOutput"></p>
        <p id="regressionStats" style="margin-top: 10px;"></p>
    </div>

    <div class="container">
        <div id="infoBox2">
            <p>LIMITATIONS:</p>
            <p>
                The linear regression model assumes weight changes linearly over time. Real weight fluctuations can be
                affected by many factors not captured here.
            </p>
            <p>DISCLAIMER:</p>
            <p>
                Always consult a healthcare professional before starting any weight management program. Use this tool as
                a
                motivational aid and trend tracker; it is not a substitute for professional medical advice or
                personalized nutrition and exercise planning.
            </p>
            <p>PRIVACY NOTE:</p>
            <p>All data you enter stays on your device and is not stored or transmitted anywhere.</p>
        </div>

        <script>
            // Keep a single entries array for all data
            const entries = [];

            // Load saved entries and initialize flatpickr when DOM is ready
            document.addEventListener("DOMContentLoaded", function () {
                const savedEntries = localStorage.getItem("weightEntries");
                if (savedEntries) {
                    const parsedEntries = JSON.parse(savedEntries);
                    parsedEntries.forEach((entry) => entries.push(entry));
                    const savedTarget = localStorage.getItem("targetWeight");
                    if (savedTarget !== null) {
                        document.getElementById("targetWeight").value = savedTarget;
                    }
                    const savedHeight = localStorage.getItem("heightCm");
                    if (savedHeight !== null) {
                        document.getElementById("heightCm").value = savedHeight;
                    }
                    updateUI();
                }

                flatpickr("#date", {
                    dateFormat: "Y-m-d",
                    defaultDate: "today",
                    altInput: true,
                    altFormat: "F j, Y",
                });
            });

            document
                .getElementById("targetWeight")
                .addEventListener("input", function () {
                    localStorage.setItem("targetWeight", this.value);
                    updateUI();
                });

            // Save height input to localStorage and update UI
            document.getElementById("heightCm").addEventListener("input", function () {
                localStorage.setItem("heightCm", this.value);
                updateUI();
            });

            // Save entries array to localStorage
            function saveEntries() {
                localStorage.setItem("weightEntries", JSON.stringify(entries));
            }

            // Calculate BMI helper
            function calculateBMI(weightKg, heightCm) {
                if (!weightKg || !heightCm) return null;
                const heightM = heightCm / 100;
                return weightKg / (heightM * heightM);
            }

            // BMI category helper
            function getBMICategory(bmi) {
                if (bmi === null) return "N/A";
                if (bmi < 18.5) return "Underweight";
                if (bmi < 25) return "Normal weight";
                if (bmi < 30) return "Overweight";
                return "Obese";
            }

            // Update UI and charts based on current entries
            function updateUI() {
                // Sort entries by date
                entries.sort((a, b) => new Date(a.date) - new Date(b.date));

                const entryList = document.getElementById("entryList");
                entryList.innerHTML = "";

                entries.forEach((entry, index) => {
                    const li = document.createElement("li");
                    li.style.display = "flex";
                    li.style.justifyContent = "space-between";
                    li.style.alignItems = "center";
                    li.style.padding = "6px 0";

                    // Entry text
                    const entryText = document.createElement("span");
                    entryText.textContent = `${entry.date}: ${entry.weight} kg`;
                    li.appendChild(entryText);

                    // Container for buttons
                    const btnContainer = document.createElement("span");

                    // Delete button
                    const deleteBtn = document.createElement("button");
                    deleteBtn.textContent = "Delete";
                    deleteBtn.onclick = () => deleteEntry(index);
                    btnContainer.appendChild(deleteBtn);

                    li.appendChild(btnContainer);
                    entryList.appendChild(li);
                });

                // Calculate BMI values for chart and current BMI display
                const heightCm = parseFloat(document.getElementById("heightCm").value);
                const bmiValues = [];

                entries.forEach((entry) => {
                    const bmi = calculateBMI(entry.weight, heightCm);
                    bmiValues.push({ date: entry.date, bmi: bmi });
                });

                // Update charts and forecast output as before...
                chart.data.labels = entries.map((entry) => entry.date);
                chart.data.datasets[0].data = entries.map((entry) => entry.weight);
                chart.update();

                // Update BMI Chart
                bmiChart.data.labels = bmiValues.map((entry) => entry.date);
                bmiChart.data.datasets[0].data = bmiValues.map((entry) => entry.bmi);
                bmiChart.update();

                const targetWeight = parseFloat(
                    document.getElementById("targetWeight").value
                );
                const forecastOutput = document.getElementById("forecastOutput");

                if (!isNaN(targetWeight)) {
                    const latestWeight =
                        entries.length > 0 ? entries[entries.length - 1].weight : null;

                    if (latestWeight !== null && latestWeight <= targetWeight) {
                        // Congratulate if target reached or passed
                        forecastOutput.textContent = `🎉 Target weight of ${targetWeight} kg reached, congratulations! 🎉`;
                    } else {
                        const prediction = estimateGoalDate(entries, targetWeight);
                        forecastOutput.textContent = prediction
                            ? `Estimated date to reach ${targetWeight} kg: ${prediction}`
                            : "Trend unclear or not enough data for prediction.";
                    }
                } else {
                    forecastOutput.textContent = "";
                }

                updateForecastChart(entries);

                // Calculate and display goal progress % with sign (negative if moving away)
                const startWeight = entries.length ? entries[0].weight : null;
                const currentWeight = entries.length ? entries[entries.length - 1].weight : null;
                let progressText = "";

                if (
                    startWeight !== null &&
                    currentWeight !== null &&
                    !isNaN(targetWeight)
                ) {
                    const totalChange = targetWeight - startWeight;  // signed difference
                    const progressChange = currentWeight - startWeight;  // signed progress

                    if (totalChange !== 0) {
                        let progressPercent = (progressChange / totalChange) * 100;
                        // Cap between -100% and 100% for display sanity
                        if (progressPercent > 100) progressPercent = 100;
                        if (progressPercent < -100) progressPercent = -100;
                        progressText = `Goal Progress: ${progressPercent.toFixed(1)}%`;
                    }
                }

                // Current BMI & category display
                const latestBMI = bmiValues.length
                    ? bmiValues[bmiValues.length - 1].bmi
                    : null;
                const bmiText = latestBMI
                    ? `Current BMI: ${latestBMI.toFixed(1)} (${getBMICategory(
                          latestBMI
                      )})`
                    : "Current BMI: N/A";

                // Add R² stats & trend text from forecastChart update to regressionStats with progress & BMI
                const statsText = document
                    .getElementById("regressionStats")
                    .innerHTML.split("<br><br>")[0]; // preserve only R² & trend from forecastChart
                document.getElementById("regressionStats").innerHTML =
                    statsText + "<br><br>" + progressText + "<br><br>" + bmiText;
            }

            // Delete an entry with confirmation
            function deleteEntry(index) {
                if (confirm("Are you sure you want to delete this entry?")) {
                    entries.splice(index, 1);
                    saveEntries();
                    updateUI();
                }
            }

            // Add new entry and update everything
            function addEntry() {
                const date = document.getElementById("date").value;
                const weight = parseFloat(document.getElementById("weight").value);

                if (!date || isNaN(weight)) {
                    alert("Please enter a valid date and weight.");
                    return;
                }

                entries.push({ date, weight });
                saveEntries();
                updateUI();

                // Clear inputs
                document.getElementById("date").value = "";
                document.getElementById("weight").value = "";
            }

            // Reset all data and clear localStorage
            function resetAll() {
                entries.length = 0;
                localStorage.removeItem("weightEntries");

                document.getElementById("entryList").innerHTML = "";

                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.update();

                forecastChart.data.datasets[0].data = [];
                forecastChart.data.datasets[1].data = [];
                forecastChart.update();

                bmiChart.data.labels = [];
                bmiChart.data.datasets[0].data = [];
                bmiChart.update();

                document.getElementById("forecastOutput").textContent = "";
                document.getElementById("regressionStats").textContent = "";
            }

            // Chart.js weight chart setup
            let chart = new Chart(document.getElementById("weightChart"), {
                type: "line",
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: "Weight (kg)",
                            data: [],
                            fill: false,
                            borderColor: "blue",
                            tension: 0.1,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: "Date" },
                        },
                        y: {
                            title: { display: true, text: "Weight (kg)" },
                        },
                    },
                },
            });

            // Chart.js forecast chart setup
            let forecastChart = new Chart(
                document.getElementById("forecastChart"),
                {
                    type: "scatter",
                    data: {
                        datasets: [
                            {
                                label: "Actual Weights",
                                data: [],
                                backgroundColor: "blue",
                                showLine: false,
                            },
                            {
                                label: "Regression Line",
                                data: [],
                                borderColor: "red",
                                type: "line",
                                fill: false,
                                pointRadius: 0,
                                borderWidth: 2,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: { display: true, text: "Days since start" },
                                type: "linear",
                                position: "bottom",
                            },
                            y: {
                                title: { display: true, text: "Weight (kg)" },
                            },
                        },
                    },
                }
            );

            // Chart.js BMI chart setup
            let bmiChart = new Chart(document.getElementById("bmiChart"), {
                type: "line",
                data: {
                    labels: [], // dates
                    datasets: [
                        {
                            label: "BMI",
                            data: [],
                            fill: false,
                            borderColor: "orange",
                            tension: 0.1,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: "Date" },
                        },
                        y: {
                            title: { display: true, text: "BMI" },
                        },
                    },
                },
            });

            // Update forecast chart and regression stats
            function updateForecastChart(entries) {
                if (entries.length < 2) return;

                const firstDate = new Date(entries[0].date);
                const x = entries.map(
                    (e) => (new Date(e.date) - firstDate) / (1000 * 60 * 60 * 24)
                );
                const y = entries.map((e) => e.weight);

                const n = x.length;
                const sumX = x.reduce((a, b) => a + b, 0);
                const sumY = y.reduce((a, b) => a + b, 0);
                const sumXY = x.reduce((acc, val, i) => acc + val * y[i], 0);
                const sumX2 = x.reduce((acc, val) => acc + val * val, 0);

                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;

                const scatterPoints = x.map((val, i) => ({ x: val, y: y[i] }));

                const targetWeight = parseFloat(
                    document.getElementById("targetWeight").value
                );
                let targetX = null;
                if (!isNaN(targetWeight) && slope !== 0) {
                    targetX = (targetWeight - intercept) / slope;
                }

                const maxX = targetX && targetX > 0 ? targetX : Math.max(...x);
                const regressionLine = [
                    { x: 0, y: intercept },
                    { x: maxX, y: slope * maxX + intercept },
                ];

                forecastChart.data.datasets[0].data = scatterPoints;
                forecastChart.data.datasets[1].data = regressionLine;
                forecastChart.update();

                // R² calculation
                const meanY = sumY / n;
                const ssTot = y.reduce((acc, yi) => acc + Math.pow(yi - meanY, 2), 0);
                const ssRes = y.reduce(
                    (acc, yi, i) => acc + Math.pow(yi - (slope * x[i] + intercept), 2),
                    0
                );
                const rSquared = 1 - ssRes / ssTot;

                let trendText = "";
                if (slope < 0) {
                    trendText = `You're losing about ${Math.abs(slope).toFixed(
                        2
                    )} kg per day.`;
                } else if (slope > 0) {
                    trendText = `You're gaining about ${slope.toFixed(2)} kg per day.`;
                } else {
                    trendText = `Your weight is staying about the same.`;
                }

                const statsText =
                    `R² = ${rSquared.toFixed(
                        2
                    )} — About ${(rSquared * 100).toFixed(
                        0
                    )}% of your weight change over time can be explained by this trend line.<br><br>` +
                    trendText;

                document.getElementById("regressionStats").innerHTML = statsText;
            }

            // Estimate goal date using linear regression
            function estimateGoalDate(entries, targetWeight) {
                if (entries.length < 2) return null;

                const firstDate = new Date(entries[0].date);
                const x = entries.map(
                    (e) => (new Date(e.date) - firstDate) / (1000 * 60 * 60 * 24)
                );
                const y = entries.map((e) => e.weight);

                const n = x.length;
                const sumX = x.reduce((a, b) => a + b, 0);
                const sumY = y.reduce((a, b) => a + b, 0);
                const sumXY = x.reduce((acc, val, i) => acc + val * y[i], 0);
                const sumX2 = x.reduce((acc, val) => acc + val * val, 0);

                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;

                if (slope === 0) return null;

                const targetX = (targetWeight - intercept) / slope;

                if (targetX < 0) return null;

                const targetDate = new Date(
                    firstDate.getTime() + targetX * 24 * 60 * 60 * 1000
                );
                return targetDate.toDateString();
            }
        </script>
    </div>
</body>

</html>
